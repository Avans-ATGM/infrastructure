#!/bin/bash


{% for server in hostvars[ansible_nodename].ssh_connectivity %}

target="{{ server }}"
timestamp=$(date +%s%N)
ssh_stats=$(nmap $target | grep ssh)

if [[ $ssh_stats == *"open"* ]]
then
    succes=1
else
    succes=0
fi

echo "systems_online,system=ssh,host=${target} online_status=$succes ${timestamp}"

{%endfor%}
