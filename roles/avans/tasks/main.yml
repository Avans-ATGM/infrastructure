#########################################################
# General creation of user accounts and user directories#
#########################################################
- name: Create our groups
  ansible.builtin.group:
    name: "{{ item.name }}"
    state: "{{ item.state | default('present') }}"
  loop: "{{ atgm_groups }}"

- name: Create our users
  user:
    name: "{{ item.name }}"
    home: "/home/{{ item.name }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    groups: "{{ item.groups | default(omit) }}"
    update_password: on_create
    password: "{{ avans_default_password | password_hash('sha512') }}"
    append: yes
  loop: "{{ atgm_users }}"

- name: Create our projects
  user:
    name: "{{ item.name }}"
    home: "{{ project_directory }}/{{ item.year }}/{{ item.name }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    groups: "{{ item.groups | default(omit) }}"
    update_password: on_create
    password: "{{ avans_default_password | password_hash('sha512') }}"
    append: yes
  loop: "{{ atgm_projects }}"
  when: item.host == inventory_hostname

- name: Create data storage to bebacked up with every project
  ansible.builtin.file:
    path: "{{ project_directory }}/{{ item.year }}/{{ item.name }}/data_storage"
    state: directory
    mode: '0755'
    owner: "{{ item.name }}"
  loop: "{{ atgm_projects }}"
  when: item.host == inventory_hostname

#- name: Create miniconda enviorment for new users
#  include_role:
#    name: galaxyproject.miniconda
#  vars:
#    miniconda_prefix: "{{ project_directory }}/{{ item.year }}/{{ item.name }}/conda"
#  loop: "{{ atgm_projects }}"
#  when: item.host == inventory_hostname


- name: create standard readme file
  copy:
    dest: "{{ project_directory }}/{{ item.year }}/{{ item.name }}/Readme"
    force: no
    group: sys
    owner: "{{ item.name }}"
    mode: '0755'
    content: |
      Dear students, welcome to your project directory.
      Use it as you see fit but here are a few things you should know:
      - Put in the data_storage are files which are essentional to yourbackup.
        May something go terrible wrong and all your data is deleted we can retrieve a backup.
        We will make an automated backup weekly (saturday) to an other machine of all files in the data_storage directory
        please keep in mind the size of this directory since due to backup it will be saved 3 times and we dont want to overload the system.

      - We will monitor howmuch storage space you are using. Try not to go over the 200 GB if it is not nessacery.

      - Therby we have alot of cores to use on this machine (28), however we have to share with other users. 
        So try not to use more than 6 cpu at the same time. For big jobs can you always ask Donny and or Bazante what the possibilities are.

      Further try also to make your own Read me files or add to this file with your favourite text editor.
      For example explain what is in every directory and what the input, output are of your scripts / commands so we can recreate everything if needed from the backups

      And remember have fun, if you have any questions please contact Donny or Bazante.
      Small tip to do.

      Change your password from the complicated autogenerated to something you like:
      ```$ passwd {{ item.name }} ``` and then follow instructions on terminal

  loop: "{{ atgm_projects }}"
  when: item.host == inventory_hostname

#- name: Select sensible default for students
#  community.general.alternatives:
#    name: editor
#    path: /bin/nano

############# General updating ########
- name: Update the apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  ignore_errors: yes

- name: Install basic packages we want everywhere
  package:
    name:
      - acl
      - at
      - atop
      - bc
      - build-essential
      - byobu
      - curl
      - emacs-nox
      - git
      - htop
      - iftop
      - iotop
      - jq
      - lsof
      - make
      - moreutils
      - nano
      - patch
      - screen
      - strace
      - sudo
      - telnet
      - tmux
      - tree
      - vim-nox
      - virtualenv
      - wget
      - zlib1g-dev
      - sshfs
      - borgbackup
      - tmpreaper

- name: Ensure services are enabled + started
  systemd:
    name: "{{ item }}"
    enabled: yes
    #state: started
  with_items:
    - atop
    - atd

#add bacup.yml tasks
- name: Include student project backup tasks
  include_tasks:
    file: backup.yml
    apply:
      tags: initialise / update backup system
  tags:
    - when there are student projects

- name: adding TMPReaper
  include_tasks:
    file: TMP_reaper.yml
    apply:
      tags: getting tmp_reaper ready
